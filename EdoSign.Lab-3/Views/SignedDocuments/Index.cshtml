@inject IHttpContextAccessor Http

@{
    var v = Http.HttpContext?.Request.Cookies["ApiVersion"] ?? "1.0";
}

<h2>Завантажені документи (API v@(v))</h2>

<table class="table" id="signedDocsTable">
    <thead>
        <tr>
            <th>Id</th>
            <th>Файл</th>       
            <th>Клієнт</th>

            @* V1 — без DocumentType та Uploaded *@
            @if (v == "2.0")
            {
                <th>Тип документа</th>
                <th>Дата завантаження</th>
            }

            <th>Статус</th>

            @if (v == "2.0")
            {
                <th>Дата підпису</th>
            }

            <th>Дії</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
    <script>

        // Додаємо можливість додавати години
        Date.prototype.addHours = function (h) {
            this.setHours(this.getHours() + h);
            return this;
        };

        async function loadSignedDocs() {
            const version = "@v";
            const response = await fetch(`/api/v${version}/signed-documents`);

            if (!response.ok) {
                console.error("Failed to load documents");
                return;
            }

            const docs = await response.json();
            const tbody = document.querySelector("#signedDocsTable tbody");
            tbody.innerHTML = "";

            docs.forEach(d => {
                const tr = document.createElement("tr");

                if (version === "2.0") {

                    const uploaded = d.uploadedAt
                        ? new Date(d.uploadedAt).toLocaleString()
                        : "-";

                    const signedAt = d.signedAt
                        ? new Date(d.signedAt).addHours(2).toLocaleString()
                        : "-";

                    tr.innerHTML = `
                        <td>${d.id}</td>
                        <td>${d.fileName}</td>
                        <td>${d.clientName}</td>
                        <td>${d.documentTypeName}</td>
                        <td>${uploaded}</td>
                        <td>${d.isSigned ? "Підписано" : "Не підписано"}</td>
                        <td>${signedAt}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteDoc(${d.id})">
                                Видалити
                            </button>
                        </td>`;
                }
                else {
                    // ▼ Версія V1 (без DocumentType, Uploaded, SignedAt)
                    tr.innerHTML = `
                        <td>${d.id}</td>
                        <td>${d.fileName}</td>
                        <td>${d.clientName}</td>
                        <td>${d.isSigned ? "Підписано" : "Не підписано"}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteDoc(${d.id})">
                                Видалити
                            </button>
                        </td>`;
                }

                tbody.appendChild(tr);
            });
        }

        async function deleteDoc(id) {
            if (!confirm("Видалити документ?")) return;

            await fetch(`/api/v2/signed-documents/${id}`, { method: "DELETE" });
            loadSignedDocs();
        }

        document.addEventListener("DOMContentLoaded", loadSignedDocs);
    </script>
}
